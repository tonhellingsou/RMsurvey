<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Data Visualization Survey 1.0.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="lib/jspsych/jspsych.css">
  <script src="lib/jspsych/jspsych.js"></script>
  <script src="lib/jspsych/plugin-preload.js"></script>
  <script src="lib/jspsych/plugin-html-button-response.js"></script>
  <script src="lib/jspsych/plugin-survey-html-form.js"></script>
  <script src="lib/jspsych/plugin-html-keyboard-response.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background:#f3f3f3; margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .jspsych-content { max-width: 900px; margin:auto; }
    img.stim { max-width:80vw; max-height:65vh; display:block; margin:1rem auto; border:1px solid #ddd; }
    .muted { color:#666; font-size:0.95rem; }

    /* Card-style radios */
    .options { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px; margin:1rem auto 0; }
    .option-card {
      display:flex; align-items:center; gap:.6rem;
      background:#fff; border:1px solid #d8dbe0; border-radius:12px; padding:.8rem .9rem;
      cursor:pointer; transition: box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }
    .option-card:hover { box-shadow:0 4px 10px rgba(0,0,0,.06); border-color:#cbd0d8; background:#f9fbff; }
    .option-card input[type="radio"] { transform:scale(1.2); accent-color:#2563eb; }

    /* Demographics layout */
    .form-grid { display:grid; gap:14px; grid-template-columns: 1fr 1fr; }
    .form-grid .full { grid-column:1 / -1; }
    .field-card {
      background:#fff; border:1px solid #d8dbe0; border-radius:12px; padding:12px 14px;
    }
    .field-card h4 { margin:.2rem 0 .6rem 0; font-size:1rem; }
    .chips { display:flex; flex-wrap:wrap; gap:10px; }
    .chip { padding:8px 12px; border-radius:999px; border:1px solid #d8dbe0; background:#fff; cursor:pointer; }
    .chip input { display:none; }
    .chip.selected { border-color:#2563eb; background:#eff6ff; }

    .btn-primary {
      display:inline-block; padding:.8rem 1.1rem; border-radius:10px; border:1px solid #2563eb;
      background:#2563eb; color:#fff; font-weight:600; cursor:pointer;
    }
    .center { text-align:center; }
    details summary { cursor:pointer; }
    .bi { vertical-align:-0.1em; }


    .field-card {
      background:#fff;
      border:1px solid #d8dbe0;
      border-radius:12px;
      padding:14px 16px;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .modern-select {
      width:100%;
      padding:.55rem .75rem;
      font-size:1rem;
      border:1px solid #cbd0d8;
      border-radius:8px;
      background:#fff;
      transition:border-color .2s, box-shadow .2s;
    }
    .modern-select:focus {
      outline:none;
      border-color:#2563eb;
      box-shadow:0 0 0 2px rgba(37,99,235,.2);
    }
  </style>
</head>
<body>
<script>
  
/* ---------------- CONFIG ---------------- */
const WEBHOOK = "https://script.google.com/macros/s/AKfycbxH_MD-ZK_fZ3Lug4WVMGb3I3VHBk5i--k_5zqAdfSdCrtovCQihElQBK4FsBN2B97x_w/exec";

// participant id
const PID = new URLSearchParams(location.search).get('pid') || (crypto.randomUUID?.() || Math.random().toString(36)).slice(0,8);

// Different answer choices per question
const ANSWER_CHOICES = {
  1: ["Op de pieken van 10u en 16u na, is de totale koffieverkoop redelijk constant gedurende de dag, maar het aandeel Americano daalt.","In de ochtend worden Cappuccino's het meest verkocht, in de avond zijn Chocolate drinks het populairst."],
  2: ["High accuracy","Moderate accuracy","Low accuracy","Cannot tell"],
  3: ["Male","Female","Other","Prefer not to say"],
  4: ["North","South","East","West"],
  5: ["Trend increasing","Trend decreasing","No clear trend","Cannot tell"],
  6: ["Group A","Group B","Group C","Group D"],
  7: ["Blue palette","Orange palette","Mixed colors","Grayscale"],
  8: ["Easily readable","Hard to read","Confusing","Visually pleasing"],
  9: ["Yes","No"],
  10:["Under 10 seconds","10–20 seconds","More than 20 seconds"]
};


// Image banks (you currently have only q1_*; keep structure and add files later)
function bank(n){
  return [
    `img/q${n}_a.jpg`,`img/q${n}_b.jpg`,`img/q${n}_c.jpg`,`img/q${n}_d.jpg`,
    `img/q${n}_e.jpg`,`img/q${n}_f.jpg`,`img/q${n}_g.jpg`,`img/q${n}_h.jpg`
  ];
}
const questionBanks = Array.from({length:10}, (_,i)=>bank(i+1));

/* ---------------- HELPERS ---------------- */
const pick = arr => arr[Math.floor(Math.random()*arr.length)];
function shuffle(a){ const c=a.slice(); for(let i=c.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [c[i],c[j]]=[c[j],c[i]];} return c; }

// POST with CORS then no-cors fallback
async function postRows(rows){
  try {
    const res = await fetch(WEBHOOK,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(rows)});
    if(res.ok) return {ok:true,mode:'cors'};
  } catch(_){}
  try {
    await fetch(WEBHOOK,{method:'POST',mode:'no-cors',body:JSON.stringify(rows)});
    return {ok:true,mode:'no-cors'};
  } catch(e){ return {ok:false,error:String(e)}; }
}

/* ---------------- JSPSYCH ---------------- */
const jsPsych = initJsPsych({
  on_finish: async () => {
    // Show saving message (no local CSV)
    document.body.innerHTML = `<div class="center" style="padding:3rem">
      <h2>Answers are being saved. Do not close this window yet.</h2>
    </div>`;

    // Collect question rows (we stored them ourselves on finishTrial)
    const qrows = jsPsych.data.get().filter({kind:'question'}).values();

    // Demographics row
    const d = jsPsych.data.get().filter({kind:'demographics'}).values()[0];
    if (d) qrows.push({
      participant_id: PID, trial: 'demographics', question_id: 'demographics',
      image: '', response: JSON.stringify(d.response || {}), rt: ''
    });

    const result = await postRows(qrows);
    document.body.innerHTML = result.ok
      ? `<div class="center" style="padding:2rem"><h2>✅ Thank you!</h2><p>Your responses have been saved.</p></div>`
      : `<div class="center" style="padding:2rem"><h2>⚠️ Upload failed.</h2><p>${result.error||''}</p></div>`;
  }
});

const timeline = [];

/* ---------------- INTRO (with icons) ---------------- */
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  choices: "NO_KEYS", // we’ll advance on click of the Begin button
  stimulus: `
    <div style="text-align:left;max-width:720px;margin:0 auto">
      <h1 style="margin:0 0 .5rem 0;">Visual Design & Interpretation Speed</h1>
      <p>Welcome! You'll answer questions about different data visualizations.</p>
      <ul style="list-style:none;padding:0;margin:1rem 0;">
        <li style="margin:.5em 0;"><i class="bi bi-stopwatch" style="color:#2563eb;margin-right:.5em;"></i>
            <b>10 images</b> to evaluate.</li>
        <li style="margin:.5em 0;"><i class="bi bi-lightning-charge" style="color:#eab308;margin-right:.5em;"></i>
            We measure your <b>reaction time</b> for each answer.</li>
        <li style="margin:.5em 0;"><i class="bi bi-hourglass-split" style="color:#f97316;margin-right:.5em;"></i>
            The survey is <b>time-bound</b> and can’t be paused.</li>
        <li style="margin:.5em 0;"><i class="bi bi-shield-lock" style="color:#16a34a;margin-right:.5em;"></i>
            Your results are <b>confidential</b>.</li>
      </ul>
      <div class="center" style="margin-top:1rem">
        <button id="begin" class="btn-primary">Begin</button>
      </div>
      <p class="muted center" style="margin-top:.5rem">Participant: <b>${PID}</b></p>
    </div>`,
  on_load: () => {
    document.getElementById('begin').addEventListener('click', () => jsPsych.finishTrial());
  }
});

/* ---------------- PRELOAD (optional, continue after errors) ---------------- */
timeline.push({
  type: jsPsychPreload,
  images: questionBanks.flat(),
  show_progress_bar:true,
  message:'Preloading images…',
  continue_after_error:true
});

/* ---------------- QUESTIONS (radio + randomized order + true one-click advance) ---------------- */
questionBanks.forEach((bank, i) => {
  const qnum = i + 1;
  const chosen = pick(bank);
  const baseChoices = ANSWER_CHOICES[qnum] || ["Option 1","Option 2"];
  const shuffled = shuffle(baseChoices);

  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    choices: "NO_KEYS", // we’ll finish the trial ourselves when a radio is clicked
    stimulus: `
      <div style="text-align:center">
        <h3>Question ${qnum} / 10</h3>
        <img class="stim" src="${chosen}" alt="stimulus ${qnum}">
        <p class="muted">Select the option that best answers the question.</p>
      </div>
      <div class="options" id="optwrap">
        ${shuffled.map(ch => `
          <label class="option-card">
            <input type="radio" name="answer" value="${ch}">
            <span>${ch}</span>
          </label>`).join("")}
      </div>
    `,
    on_load: () => {
      const root = jsPsych.getDisplayElement();
      const img  = root.querySelector('img.stim');
      const radios = root.querySelectorAll('input[type=radio][name=answer]');
    
      // Disable radios until the image is fully decoded and painted.
      radios.forEach(r => r.disabled = true);
    
      let t0 = 0;
      const start = () => {
        // mark the real start time only now (image visible)
        t0 = performance.now();
        radios.forEach(r => r.disabled = false);
      };
    
      // Start timing after the browser confirms pixels are ready
      if (img && typeof img.decode === 'function') {
        img.decode().catch(()=>{}).finally(start);
      } else {
        // Fallback if decode() isn’t supported
        if (img && !img.complete) img.addEventListener('load', start, { once:true });
        else start();
      }
    
      // One-click advance with correct RT
      radios.forEach(r => {
        r.addEventListener('change', () => {
          const rt = Math.round(performance.now() - t0);
          jsPsych.finishTrial({
            kind: 'question',
            participant_id: PID,
            question_id: `Q${qnum}`,
            image: chosen,
            response: r.value,
            rt: rt,
            choice_order: shuffled.join(' | ')
          });
        }, { once:true });
      });
    }
  });
});

/* ---------------- DEMOGRAPHICS (modern dropdowns) ---------------- */
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  choices: "NO_KEYS",
  stimulus: `
    <div style="max-width:600px;margin:0 auto;">
      <h3 class="center">Almost done — a few background questions</h3>

      <div class="field-card" style="margin-top:1rem;">
        <label style="display:block;margin-bottom:.3rem;font-weight:600;">Age group</label>
        <select name="age" id="age" class="modern-select">
          <option value="">Select…</option>
          <option>18–24</option>
          <option>25–34</option>
          <option>35–44</option>
          <option>45–54</option>
          <option>55–64</option>
          <option>65+</option>
        </select>
      </div>

      <div class="field-card" style="margin-top:1rem;">
        <label style="display:block;margin-bottom:.3rem;font-weight:600;">Highest education</label>
        <select name="education" id="education" class="modern-select">
          <option value="">Select…</option>
          <option>High school</option>
          <option>Bachelor</option>
          <option>Master</option>
          <option>PhD</option>
          <option>Other</option>
        </select>
      </div>

      <div class="field-card" style="margin-top:1rem;">
        <label style="display:block;margin-bottom:.3rem;font-weight:600;">Gender</label>
        <select name="gender" id="gender" class="modern-select">
          <option value="">Select…</option>
          <option>Male</option>
          <option>Female</option>
          <option>Other</option>
          <option>Prefer not to say</option>
        </select>
      </div>

      <div class="field-card" style="margin-top:1rem;">
        <label style="display:block;margin-bottom:.3rem;font-weight:600;">Self-reported data literacy (1–5)</label>
        <input type="range" id="literacy" min="1" max="5" step="1" value="3"
          oninput="document.getElementById('litval').textContent=this.value"
          style="width:100%;">
        <div class="center muted">Value: <span id="litval">3</span></div>
      </div>

      <div class="field-card" style="margin-top:1rem;">
        <label style="display:block;margin-bottom:.3rem;font-weight:600;">Industry of work</label>
        <select name="industry" id="industry" class="modern-select">
          <option value="">Select…</option>
          <option>Administratieve beroepen</option>
          <option>Agrarisch en groen</option>
          <option>Autobranche</option>
          <option>Bouw</option>
          <option>Cultuur, sport en recreatie</option>
          <option>Detail- en groothandel</option>
          <option>Financiële dienstverlening</option>
          <option>Horeca</option>
          <option>ICT-beroepen</option>
          <option>Industrie</option>
          <option>Klimaat</option>
          <option>Onderwijs</option>
          <option>Overheid</option>
          <option>Sociaal werk, jeugdzorg en kinderopvang</option>
          <option>Transport en logistiek</option>
          <option>Zakelijke dienstverlening</option>
          <option>Zorg</option>
        </select>
      </div>

      <div class="center" style="margin-top:1.5rem;">
        <button id="submit-demo" class="btn-primary">Submit</button>
      </div>
    </div>
  `,
  on_load: () => {
    document.getElementById('submit-demo').addEventListener('click', () => {
      const getVal = id => document.getElementById(id).value.trim();
      const payload = {
        age: getVal('age'),
        education: getVal('education'),
        gender: getVal('gender'),
        literacy: getVal('literacy'),
        industry: getVal('industry')
      };
      // simple validation
      const missing = ['age','education','gender','industry'].filter(k => !payload[k]);
      if (missing.length) {
        alert("Please fill in: " + missing.join(", "));
        return;
      }
      jsPsych.finishTrial({ kind:'demographics', response: payload });
    });
  }
});

/* ---------------- RUN ---------------- */
jsPsych.run(timeline);
</script>
</body>
</html>
