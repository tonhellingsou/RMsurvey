<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Data Visualization Survey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="lib/jspsych/jspsych.css">
  <script src="lib/jspsych/jspsych.js"></script>
  <script src="lib/jspsych/plugin-fullscreen.js"></script>
  <script src="lib/jspsych/plugin-preload.js"></script>
  <script src="lib/jspsych/plugin-html-button-response.js"></script>
  <script src="lib/jspsych/plugin-survey-html-form.js"></script>

  <style>
    body { background:#f3f3f3; margin:0; font-family:system-ui,sans-serif; }
    .jspsych-content { max-width:900px; margin:auto; }
    img.stim { max-width:80vw; max-height:65vh; display:block; margin:1rem auto; border:1px solid #ccc; }
    .muted { color:#666; font-size:0.9em; }
  </style>
</head>
<body>
<script>
/* ---------------- CONFIG ---------------- */
const WEBHOOK = "https://script.google.com/macros/s/AKfycbxH_MD-ZK_fZ3Lug4WVMGb3I3VHBk5i--k_5zqAdfSdCrtovCQihElQBK4FsBN2B97x_w/exec";

// participant id
const PID = new URLSearchParams(location.search).get('pid') || (crypto.randomUUID?.() || Math.random().toString(36)).slice(0,8);

// Different answer choices per question
const ANSWER_CHOICES = {
  1: ["Bar chart","Line chart","Pie chart","Scatter plot"],
  2: ["High accuracy","Moderate accuracy","Low accuracy","Cannot tell"],
  3: ["Male","Female","Other","Prefer not to say"],
  4: ["North","South","East","West"],
  5: ["Trend increasing","Trend decreasing","No clear trend","Cannot tell"],
  6: ["Group A","Group B","Group C","Group D"],
  7: ["Blue palette","Orange palette","Mixed colors","Grayscale"],
  8: ["Easily readable","Hard to read","Confusing","Visually pleasing"],
  9: ["Yes","No"],
  10:["Under 10 seconds","10–20 seconds","More than 20 seconds"]
};

// image banks
function bank(n){
  return [
    `img/q${n}_a.jpg`,`img/q${n}_b.jpg`,`img/q${n}_c.jpg`,`img/q${n}_d.jpg`,
    `img/q${n}_e.jpg`,`img/q${n}_f.jpg`,`img/q${n}_g.jpg`,`img/q${n}_h.jpg`
  ];
}
const questionBanks = Array.from({length:10}, (_,i)=>bank(i+1));

/* ---------------- HELPER ---------------- */
const pick = arr => arr[Math.floor(Math.random()*arr.length)];

async function postRows(rows){
  // same CORS+no-cors fallback
  try {
    const res = await fetch(WEBHOOK, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(rows)
    });
    if(res.ok) return {ok:true,mode:'cors'};
  } catch(_){}
  try {
    await fetch(WEBHOOK,{method:'POST',mode:'no-cors',body:JSON.stringify(rows)});
    return {ok:true,mode:'no-cors'};
  } catch(e){ return {ok:false,error:String(e)}; }
}

/* ---------------- JSPSYCH ---------------- */
const jsPsych = initJsPsych({
  on_finish: async () => {
    // show saving message
    document.body.innerHTML = `
      <div style="text-align:center;padding:3rem">
        <h2>Answers are being saved.<br>Please do not close this window yet.</h2>
      </div>`;
    // gather all trials
    const trials = jsPsych.data.get().filter({trial_type:'html-button-response'}).values();
    const rows = trials.map((t,i)=>({
      participant_id:PID,
      trial:i+1,
      question_id:t.question_id,
      image:t.image,
      response:t.response,
      rt:Math.round(t.rt)
    }));
    // also demographic data
    const demo = jsPsych.data.get().filter({trial_type:'survey-html-form'}).values()[0];
    rows.push({
      participant_id:PID,
      trial:'demographics',
      question_id:'demographics',
      image:'',
      response:JSON.stringify(demo.response),
      rt:''
    });

    const result = await postRows(rows);
    document.body.innerHTML = result.ok
      ? `<div style="padding:2rem;text-align:center"><h2>✅ Thank you!</h2><p>Your responses have been saved (${result.mode}).</p></div>`
      : `<div style="padding:2rem;text-align:center"><h2>⚠️ Upload failed.</h2><p>${result.error||''}</p></div>`;
  }
});

const timeline = [];

/* ---------------- INSTRUCTIONS ---------------- */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div style="text-align:left;max-width:700px;margin:auto">
      <h1>Visual Design and Interpretation Speed Study</h1>
      <p>Welcome! In this survey you will answer questions about different data visualizations.</p>
      <p>You will see <b>10 images</b> in total. For each one, answer a short multiple-choice question.</p>
      <ul>
        <li>Your reaction time will be measured from the moment the question appears until you click an answer.</li>
        <li>The survey is <b>time-bound</b>: once started, it cannot be paused.</li>
        <li>Please complete it in one sitting and avoid switching tabs or windows.</li>
        <li>Your answers are <b>confidential</b> and will only be used for research purposes.</li>
      </ul>
      <p class="muted">Click “Begin” when you are ready.</p>
    </div>`,
  choices:["Begin"]
});

/* ---------------- PRELOAD ---------------- */
timeline.push({
  type: jsPsychPreload,
  images: questionBanks.flat(),
  show_progress_bar:true,
  message:'Preloading images…',
  continue_after_error:true
});


/* ---------------- QUESTIONS ---------------- */
questionBanks.forEach((bank,i)=>{
  const qnum=i+1;
  const chosen=pick(bank);
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <div style="text-align:center">
        <h3>Question ${qnum} / 10</h3>
        <img class="stim" src="${chosen}" alt="stimulus ${qnum}">
        <p class="muted">Please select the option that best answers the question about this figure.</p>
      </div>`,
    choices: ANSWER_CHOICES[qnum] || ["Option 1","Option 2"],
    data:{question_id:`Q${qnum}`,image:chosen}
  });
});

/* ---------------- DEMOGRAPHICS ---------------- */
timeline.push({
  type: jsPsychSurveyHtmlForm,
  preamble: "<h3>Almost done!</h3><p>Please provide some background information.</p>",
  html: `
    <p><label>Age group:<br>
      <select name="age">
        <option value="">Select…</option>
        <option>18–24</option><option>25–34</option><option>35–44</option>
        <option>45–54</option><option>55–64</option><option>65+</option>
      </select></label></p>

    <p><label>Highest education:<br>
      <select name="education">
        <option value="">Select…</option>
        <option>High school</option><option>Bachelor</option>
        <option>Master</option><option>PhD</option><option>Other</option>
      </select></label></p>

    <p><label>Industry of work:<br>
      <input name="industry" style="width:100%" placeholder="e.g., Education, IT, Healthcare"></label></p>

    <p><label>Self-reported data literacy (1–5):<br>
      <input type="range" name="literacy" min="1" max="5" step="1" value="3"
        oninput="this.nextElementSibling.value=this.value">
      <output>3</output>
    </label></p>
  `,
  button_label:"Submit"
});

/* ---------------- RUN ---------------- */
jsPsych.run(timeline);
</script>
</body>
</html>
